select(!starts_with("seq."))
out=paste(adat_f,".",label,".data.tsv",sep='')
write.table(
cd_filtered,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
# Compare Two Groups
# Get annotations via getAnalyteInfo():
t_tests <- getAnalyteInfo(cleanData) |>
select(AptName, SeqId, Target = TargetFullName, EntrezGeneSymbol, UniProt)
#Calculate t-tests
t_tests <- t_tests |>
mutate(
formula = map(AptName, ~ as.formula(paste(.x, paste("~ ",comp_name,sep = "")))), # create formula
t_test  = map(formula, ~ stats::t.test(.x, data = cleanData)),  # fit t-tests
t_stat  = map_dbl(t_test, "statistic"),            # pull out t-statistic
p.value = map_dbl(t_test, "p.value"),              # pull out p-values
fdr     = p.adjust(p.value, method = "BH")         # FDR for multiple testing
) |>
arrange(p.value) |>            # re-order by `p-value`
mutate(rank = row_number())    # add numeric ranks
out=paste(adat_f,".",label,".ttest.tsv",sep='')
t <- as.data.frame(t_tests)
df = t[,!(names(t) %in% c('formula', 't_test'))]
write.table(
df,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
# ouptut all targets
target_map_all <- t_tests |>     # mapping table
select(AptName, EntrezGeneSymbol, UniProt, Target)               # SeqId -> Target
out=paste(adat_f,".all_targets.tsv",sep='')
t <- as.data.frame(target_map_all)
write.table(
t,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
# ouptut all targets data
target_map_all <- t_tests |>     # mapping table
select(AptName, EntrezGeneSymbol)                # SeqId -> Target
all_data_tbl <- my_adat |>             # plot non-center/scale data
rownames_to_column("annot_id") |>
# Join with annot_tbl on the common 'annot_id' column
left_join(annot_tbl, by = "annot_id") |>
filter(SampleType == "Sample") |>     # rm control samples
filter((!!as.symbol(comp_name)) == lbl1 | (!!as.symbol(comp_name)) == lbl2) |>          # filter for CompE E_Post and E_Pre samples
drop_na((!!as.symbol(comp_name))) |>                       # rm NAs if present
log10() |>                            # log10-transform for plotting
select((!!as.symbol(comp_name)), target_map_all$AptName) |>    # top 12 analytes
pivot_longer(cols = -(!!as.symbol(comp_name)), names_to = "AptName", values_to = "RFU") |>
left_join(target_map_all, by = "AptName") #|>
# order factor levels by 't_tests' rank to order plots below
#mutate(EntrezGeneSymbol = factor(EntrezGeneSymbol, levels = target_map_all$EntrezGeneSymbol))
pt <- as.data.frame(all_data_tbl)
# sink()
out=paste(adat_f,".",label,".alldata.tsv",sep='')
write.table(
pt,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
# plot top hits
target_map <- head(t_tests, 5L) |>     # mapping table
select(AptName, EntrezGeneSymbol)               # SeqId -> Target
plot_tbl <- my_adat |>             # plot non-center/scale data
rownames_to_column("annot_id") |>
# Join with annot_tbl on the common 'annot_id' column
left_join(annot_tbl, by = "annot_id") |>
filter(SampleType == "Sample") |>     # rm control samples
filter((!!as.symbol(comp_name)) == lbl1 | (!!as.symbol(comp_name)) == lbl2) |>          # filter for CompE E_Post and E_Pre samples
drop_na((!!as.symbol(comp_name))) |>                       # rm NAs if present
log10() |>                            # log10-transform for plotting
select((!!as.symbol(comp_name)), target_map$AptName) |>    # top 12 analytes
pivot_longer(cols = -(!!as.symbol(comp_name)), names_to = "AptName", values_to = "RFU") |>
left_join(target_map, by = "AptName") |>
# order factor levels by 't_tests' rank to order plots below
mutate(EntrezGeneSymbol = factor(EntrezGeneSymbol, levels = target_map$EntrezGeneSymbol))
pt <- as.data.frame(plot_tbl)
# sink()
out=paste(adat_f,".",label,".plotdata.tsv",sep='')
write.table(
pt,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
plot_tbl |>
ggplot(aes(x = (!!as.symbol(comp_name)), y = RFU, fill = (!!as.symbol(comp_name)))) +
geom_boxplot(alpha = 0.5, outlier.shape = NA) +
scale_fill_manual(values = c("#24135F", "#00A499")) +
geom_jitter(shape = 16, width = 0.1, alpha = 0.5) +
facet_wrap(~ EntrezGeneSymbol, ncol = 3) +
ggtitle("Boxplots of Top Analytes by t-test") +
labs(y = "log10(RFU)") +
theme(plot.title = element_text(size = 21, face = "bold"),
axis.title.x = element_text(size = 14),
axis.title.y = element_text(size = 14),
legend.position = "top"
)
out=paste(adat_f,".",label,".png",sep='')
ggsave(out,dpi=300)
lbl1 <- "NEPost"
lbl2 <- "Covid"
label <- paste(lbl1,"vs",lbl2,sep='_')
## compare NEPre to Covid
# lbl1 <- "NEPre"
# lbl2 <- "Covid"
# label <- paste(lbl1,"vs",lbl2,sep='_')
adat_f <- "/storage/Documents/service/externe/sheela/20240606_LC_exercice_somalogic/results/SS-2453319_v4.1_EDTAPlasma.hybNorm.medNormInt.plateScale.calibrate.anmlQC.qcCheck.anmlSMP.20240528.adat"
annot_f <- "/storage/Documents/service/externe/sheela/20240606_LC_exercice_somalogic/results/plate_sample_annot.tsv"
my_adat <- read_adat(adat_f)
annot_tbl <- read.csv(
annot_f,
header = TRUE,
sep="\t",
stringsAsFactors=FALSE
)
# # prepare data set for analysis
# cleanData <- my_adat |>
#   filter(SampleType == "Sample") |>          # rm control samples
#   filter((!!as.symbol(comp_name)) == lbl1 | (!!as.symbol(comp_name)) == lbl2) |>          # filter for CompE E_Post and E_Pre samples
#   drop_na((!!as.symbol(comp_name))) |>                      # rm NAs if present
#   log10() |>                                 # log10-transform (Math Generic)
#   modify_at(getAnalytes(my_adat), cs)   # center/scale analytes
cleanData <- my_adat |>
# Convert my_adat row names to a column named 'annot_id'
rownames_to_column("annot_id") |>
# Join with annot_tbl on the common 'annot_id' column
left_join(annot_tbl, by = "annot_id") |>
filter(SampleType == "Sample") |> # rm control samples
filter((!!as.symbol(comp_name)) == lbl1 | (!!as.symbol(comp_name)) == lbl2) |> # filter for CompE E_Post and E_Pre samples
drop_na((!!as.symbol(comp_name))) |> # rm NAs if present
log10() |>                                 # log10-transform (Math Generic)
mutate(across(where(is.numeric), log10)) |> # log10-transform numeric columns
mutate(across(getAnalytes(my_adat), cs)) # center/scale analytes
cd_raw <- as.data.frame(cleanData)
cd_filtered <- cd_raw %>%
select(!starts_with("seq."))
out=paste(adat_f,".",label,".data.tsv",sep='')
write.table(
cd_filtered,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
# Compare Two Groups
# Get annotations via getAnalyteInfo():
t_tests <- getAnalyteInfo(cleanData) |>
select(AptName, SeqId, Target = TargetFullName, EntrezGeneSymbol, UniProt)
#Calculate t-tests
t_tests <- t_tests |>
mutate(
formula = map(AptName, ~ as.formula(paste(.x, paste("~ ",comp_name,sep = "")))), # create formula
t_test  = map(formula, ~ stats::t.test(.x, data = cleanData)),  # fit t-tests
t_stat  = map_dbl(t_test, "statistic"),            # pull out t-statistic
p.value = map_dbl(t_test, "p.value"),              # pull out p-values
fdr     = p.adjust(p.value, method = "BH")         # FDR for multiple testing
) |>
arrange(p.value) |>            # re-order by `p-value`
mutate(rank = row_number())    # add numeric ranks
out=paste(adat_f,".",label,".ttest.tsv",sep='')
t <- as.data.frame(t_tests)
df = t[,!(names(t) %in% c('formula', 't_test'))]
write.table(
df,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
# ouptut all targets
target_map_all <- t_tests |>     # mapping table
select(AptName, EntrezGeneSymbol, UniProt, Target)               # SeqId -> Target
out=paste(adat_f,".all_targets.tsv",sep='')
t <- as.data.frame(target_map_all)
write.table(
t,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
# ouptut all targets data
target_map_all <- t_tests |>     # mapping table
select(AptName, EntrezGeneSymbol)                # SeqId -> Target
all_data_tbl <- my_adat |>             # plot non-center/scale data
rownames_to_column("annot_id") |>
# Join with annot_tbl on the common 'annot_id' column
left_join(annot_tbl, by = "annot_id") |>
filter(SampleType == "Sample") |>     # rm control samples
filter((!!as.symbol(comp_name)) == lbl1 | (!!as.symbol(comp_name)) == lbl2) |>          # filter for CompE E_Post and E_Pre samples
drop_na((!!as.symbol(comp_name))) |>                       # rm NAs if present
log10() |>                            # log10-transform for plotting
select((!!as.symbol(comp_name)), target_map_all$AptName) |>    # top 12 analytes
pivot_longer(cols = -(!!as.symbol(comp_name)), names_to = "AptName", values_to = "RFU") |>
left_join(target_map_all, by = "AptName") #|>
# order factor levels by 't_tests' rank to order plots below
#mutate(EntrezGeneSymbol = factor(EntrezGeneSymbol, levels = target_map_all$EntrezGeneSymbol))
pt <- as.data.frame(all_data_tbl)
# sink()
out=paste(adat_f,".",label,".alldata.tsv",sep='')
write.table(
pt,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
# plot top hits
target_map <- head(t_tests, 5L) |>     # mapping table
select(AptName, EntrezGeneSymbol)               # SeqId -> Target
plot_tbl <- my_adat |>             # plot non-center/scale data
rownames_to_column("annot_id") |>
# Join with annot_tbl on the common 'annot_id' column
left_join(annot_tbl, by = "annot_id") |>
filter(SampleType == "Sample") |>     # rm control samples
filter((!!as.symbol(comp_name)) == lbl1 | (!!as.symbol(comp_name)) == lbl2) |>          # filter for CompE E_Post and E_Pre samples
drop_na((!!as.symbol(comp_name))) |>                       # rm NAs if present
log10() |>                            # log10-transform for plotting
select((!!as.symbol(comp_name)), target_map$AptName) |>    # top 12 analytes
pivot_longer(cols = -(!!as.symbol(comp_name)), names_to = "AptName", values_to = "RFU") |>
left_join(target_map, by = "AptName") |>
# order factor levels by 't_tests' rank to order plots below
mutate(EntrezGeneSymbol = factor(EntrezGeneSymbol, levels = target_map$EntrezGeneSymbol))
pt <- as.data.frame(plot_tbl)
# sink()
out=paste(adat_f,".",label,".plotdata.tsv",sep='')
write.table(
pt,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
plot_tbl |>
ggplot(aes(x = (!!as.symbol(comp_name)), y = RFU, fill = (!!as.symbol(comp_name)))) +
geom_boxplot(alpha = 0.5, outlier.shape = NA) +
scale_fill_manual(values = c("#24135F", "#00A499")) +
geom_jitter(shape = 16, width = 0.1, alpha = 0.5) +
facet_wrap(~ EntrezGeneSymbol, ncol = 3) +
ggtitle("Boxplots of Top Analytes by t-test") +
labs(y = "log10(RFU)") +
theme(plot.title = element_text(size = 21, face = "bold"),
axis.title.x = element_text(size = 14),
axis.title.y = element_text(size = 14),
legend.position = "top"
)
out=paste(adat_f,".",label,".png",sep='')
ggsave(out,dpi=300)
lbl1 <- "NEPre"
lbl2 <- "Covid"
label <- paste(lbl1,"vs",lbl2,sep='_')
adat_f <- "/storage/Documents/service/externe/sheela/20240606_LC_exercice_somalogic/results/SS-2453319_v4.1_EDTAPlasma.hybNorm.medNormInt.plateScale.calibrate.anmlQC.qcCheck.anmlSMP.20240528.adat"
annot_f <- "/storage/Documents/service/externe/sheela/20240606_LC_exercice_somalogic/results/plate_sample_annot.tsv"
my_adat <- read_adat(adat_f)
annot_tbl <- read.csv(
annot_f,
header = TRUE,
sep="\t",
stringsAsFactors=FALSE
)
# # prepare data set for analysis
# cleanData <- my_adat |>
#   filter(SampleType == "Sample") |>          # rm control samples
#   filter((!!as.symbol(comp_name)) == lbl1 | (!!as.symbol(comp_name)) == lbl2) |>          # filter for CompE E_Post and E_Pre samples
#   drop_na((!!as.symbol(comp_name))) |>                      # rm NAs if present
#   log10() |>                                 # log10-transform (Math Generic)
#   modify_at(getAnalytes(my_adat), cs)   # center/scale analytes
cleanData <- my_adat |>
# Convert my_adat row names to a column named 'annot_id'
rownames_to_column("annot_id") |>
# Join with annot_tbl on the common 'annot_id' column
left_join(annot_tbl, by = "annot_id") |>
filter(SampleType == "Sample") |> # rm control samples
filter((!!as.symbol(comp_name)) == lbl1 | (!!as.symbol(comp_name)) == lbl2) |> # filter for CompE E_Post and E_Pre samples
drop_na((!!as.symbol(comp_name))) |> # rm NAs if present
log10() |>                                 # log10-transform (Math Generic)
mutate(across(where(is.numeric), log10)) |> # log10-transform numeric columns
mutate(across(getAnalytes(my_adat), cs)) # center/scale analytes
cd_raw <- as.data.frame(cleanData)
cd_filtered <- cd_raw %>%
select(!starts_with("seq."))
out=paste(adat_f,".",label,".data.tsv",sep='')
write.table(
cd_filtered,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
# Compare Two Groups
# Get annotations via getAnalyteInfo():
t_tests <- getAnalyteInfo(cleanData) |>
select(AptName, SeqId, Target = TargetFullName, EntrezGeneSymbol, UniProt)
#Calculate t-tests
t_tests <- t_tests |>
mutate(
formula = map(AptName, ~ as.formula(paste(.x, paste("~ ",comp_name,sep = "")))), # create formula
t_test  = map(formula, ~ stats::t.test(.x, data = cleanData)),  # fit t-tests
t_stat  = map_dbl(t_test, "statistic"),            # pull out t-statistic
p.value = map_dbl(t_test, "p.value"),              # pull out p-values
fdr     = p.adjust(p.value, method = "BH")         # FDR for multiple testing
) |>
arrange(p.value) |>            # re-order by `p-value`
mutate(rank = row_number())    # add numeric ranks
out=paste(adat_f,".",label,".ttest.tsv",sep='')
t <- as.data.frame(t_tests)
df = t[,!(names(t) %in% c('formula', 't_test'))]
write.table(
df,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
# ouptut all targets
target_map_all <- t_tests |>     # mapping table
select(AptName, EntrezGeneSymbol, UniProt, Target)               # SeqId -> Target
out=paste(adat_f,".all_targets.tsv",sep='')
t <- as.data.frame(target_map_all)
write.table(
t,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
# ouptut all targets data
target_map_all <- t_tests |>     # mapping table
select(AptName, EntrezGeneSymbol)                # SeqId -> Target
all_data_tbl <- my_adat |>             # plot non-center/scale data
rownames_to_column("annot_id") |>
# Join with annot_tbl on the common 'annot_id' column
left_join(annot_tbl, by = "annot_id") |>
filter(SampleType == "Sample") |>     # rm control samples
filter((!!as.symbol(comp_name)) == lbl1 | (!!as.symbol(comp_name)) == lbl2) |>          # filter for CompE E_Post and E_Pre samples
drop_na((!!as.symbol(comp_name))) |>                       # rm NAs if present
log10() |>                            # log10-transform for plotting
select((!!as.symbol(comp_name)), target_map_all$AptName) |>    # top 12 analytes
pivot_longer(cols = -(!!as.symbol(comp_name)), names_to = "AptName", values_to = "RFU") |>
left_join(target_map_all, by = "AptName") #|>
# order factor levels by 't_tests' rank to order plots below
#mutate(EntrezGeneSymbol = factor(EntrezGeneSymbol, levels = target_map_all$EntrezGeneSymbol))
pt <- as.data.frame(all_data_tbl)
# sink()
out=paste(adat_f,".",label,".alldata.tsv",sep='')
write.table(
pt,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
# plot top hits
target_map <- head(t_tests, 5L) |>     # mapping table
select(AptName, EntrezGeneSymbol)               # SeqId -> Target
plot_tbl <- my_adat |>             # plot non-center/scale data
rownames_to_column("annot_id") |>
# Join with annot_tbl on the common 'annot_id' column
left_join(annot_tbl, by = "annot_id") |>
filter(SampleType == "Sample") |>     # rm control samples
filter((!!as.symbol(comp_name)) == lbl1 | (!!as.symbol(comp_name)) == lbl2) |>          # filter for CompE E_Post and E_Pre samples
drop_na((!!as.symbol(comp_name))) |>                       # rm NAs if present
log10() |>                            # log10-transform for plotting
select((!!as.symbol(comp_name)), target_map$AptName) |>    # top 12 analytes
pivot_longer(cols = -(!!as.symbol(comp_name)), names_to = "AptName", values_to = "RFU") |>
left_join(target_map, by = "AptName") |>
# order factor levels by 't_tests' rank to order plots below
mutate(EntrezGeneSymbol = factor(EntrezGeneSymbol, levels = target_map$EntrezGeneSymbol))
pt <- as.data.frame(plot_tbl)
# sink()
out=paste(adat_f,".",label,".plotdata.tsv",sep='')
write.table(
pt,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
plot_tbl |>
ggplot(aes(x = (!!as.symbol(comp_name)), y = RFU, fill = (!!as.symbol(comp_name)))) +
geom_boxplot(alpha = 0.5, outlier.shape = NA) +
scale_fill_manual(values = c("#24135F", "#00A499")) +
geom_jitter(shape = 16, width = 0.1, alpha = 0.5) +
facet_wrap(~ EntrezGeneSymbol, ncol = 3) +
ggtitle("Boxplots of Top Analytes by t-test") +
labs(y = "log10(RFU)") +
theme(plot.title = element_text(size = 21, face = "bold"),
axis.title.x = element_text(size = 14),
axis.title.y = element_text(size = 14),
legend.position = "top"
)
out=paste(adat_f,".",label,".png",sep='')
ggsave(out,dpi=300)
adat_f <- "/storage/Documents/service/externe/sheela/20240606_LC_exercice_somalogic/results/SS-2453319_v4.1_EDTAPlasma.hybNorm.medNormInt.plateScale.calibrate.anmlQC.qcCheck.anmlSMP.20240528.adat"
annot_f <- "/storage/Documents/service/externe/sheela/20240606_LC_exercice_somalogic/results/plate_sample_annot.tsv"
outpath <- "/storage/Documents/service/externe/sheela/20240606_LC_exercice_somalogic/results.take4"
comp_name <- "CompE"
my_adat <- read_adat(adat_f)
annot_tbl <- read.csv(
annot_f,
header = TRUE,
sep="\t",
row.names = 1,
stringsAsFactors=FALSE
)
adat_f <- "/storage/Documents/service/externe/sheela/20240606_LC_exercice_somalogic/results/SS-2453319_v4.1_EDTAPlasma.hybNorm.medNormInt.plateScale.calibrate.anmlQC.qcCheck.anmlSMP.20240528.adat"
annot_f <- "/storage/Documents/service/externe/sheela/20240606_LC_exercice_somalogic/results/plate_sample_annot.tsv"
outpath <- "/storage/Documents/service/externe/sheela/20240606_LC_exercice_somalogic/results.take4"
comp_name <- "CompE"
my_adat <- read_adat(adat_f)
annot_tbl <- read.csv(
annot_f,
header = TRUE,
sep="\t",
row.names = 1,
stringsAsFactors=FALSE
)
cleanData <- my_adat |>
# Convert my_adat row names to a column named 'annot_id'
rownames_to_column("annot_id") |>
# Join with annot_tbl on the common 'annot_id' column
left_join(annot_tbl, by = "annot_id") |>
filter(SampleType == "Sample") |>
drop_na((!!as.symbol(comp_name)))
raw <- as.data.frame(cleanData)
# output raw data to tsv
out=paste(outpath,"/adat.raw.t.tsv",sep='')
write.table(
raw,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
target_map_all <-  getAnalyteInfo(cleanData) |>
select(AptName, SeqId, Target = TargetFullName, EntrezGeneSymbol, UniProt)
tm <- as.data.frame(target_map_all)
out=paste(outpath,"/all_targets.tsv",sep='')
write.table(
tm,
file = out,
sep = "\t",
row.names = FALSE,
col.names = TRUE
)
raw <- as.data.frame(cleanData)
raw_filtered <- cd_raw %>%
select(!starts_with("seq."))
out=paste(adat_f,".",label,".data.filtered.tsv",sep='')
write.table(
raw_filtered,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
raw <- as.data.frame(cleanData)
raw_filtered <- raw %>%
select(!starts_with("seq."))
out=paste(adat_f,".",label,".data.filtered.tsv",sep='')
write.table(
raw_filtered,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
out
out=paste(outpath,".",label,".data.filtered.tsv",sep='')
write.table(
raw_filtered,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
out
out=paste(outpath,"/adat.raw.filtered.tsv",sep='')
write.table(
raw_filtered,
file = out,
sep = "\t",
row.names = TRUE,
col.names = TRUE
)
target_map_all <-  getAnalyteInfo(cleanData) |>
select(AptName, SeqId, Target = TargetFullName, EntrezGeneSymbol, UniProt)
tm <- as.data.frame(target_map_all)
out=paste(outpath,"/all_targets.tsv",sep='')
write.table(
tm,
file = out,
sep = "\t",
row.names = FALSE,
col.names = TRUE
)
library("ComplexHeatmap")
library(ggbiplot)
